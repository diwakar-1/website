<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediClick</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500&family=Raleway:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Roboto', sans-serif; }
    h1, h2, h3, button, .font-poppins { font-family: 'Raleway', sans-serif; }
    .fade-in { animation: fadeIn 0.8s ease-in-out; }
    .slide-up { animation: slideUp 0.8s ease-in-out; }
    .ripple {
      position: relative;
      overflow: hidden;
    }
    .ripple:after {
      content: "";
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      background: radial-gradient(circle, rgba(255,255,255,0.5) 10%, transparent 10.01%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10,10);
      opacity: 0;
      transition: transform .5s, opacity 1s;
    }
    .ripple:active:after {
      transform: scale(0,0);
      opacity: .3;
      transition: 0s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    html { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-100 to-purple-100 min-h-screen p-4">

  <!-- Container -->
  <div class="max-w-6xl mx-auto bg-white/80 backdrop-blur-lg rounded-2xl shadow-2xl overflow-hidden border border-gray-200 fade-in">

    <!-- Header / Hero Section -->
    <header class="relative bg-gradient-to-r from-indigo-600 via-blue-500 to-teal-500 text-white p-10 shadow-xl overflow-hidden">
      <!-- Abstract background pattern -->
      <div class="absolute inset-0 opacity-10 bg-[url('https://www.toptal.com/designers/subtlepatterns/patterns/double-bubble-outline.png')] bg-repeat"></div>
      
      <div class="relative z-10 grid md:grid-cols-2 gap-8 items-center">
        <!-- Logo + Text -->
        <div class="text-center md:text-left">
          <div class="flex justify-center md:justify-start mb-4">
            <div class="w-16 h-16 bg-gradient-to-r from-purple-400 to-indigo-600 rounded-full flex items-center justify-center shadow-lg">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-8 h-8">
                <path fill-rule="evenodd" d="M1 5.25A2.25 2.25 0 0 1 3.25 3h13.5A2.25 2.25 0 0 1 19 5.25v9.5A2.25 2.25 0 0 1 16.75 17H3.25A2.25 2.25 0 0 1 1 14.75v-9.5Zm1.5 5.81v3.69c0 .414.336.75.75.75h13.5a.75.75 0 0 0 .75-.75v-2.69l-2.22-2.219a.75.75 0 0 0-1.06 0l-1.91 1.909.47.47a.75.75 0 1 1-1.06 1.06L6.53 8.091a.75.75 0 0 0-1.06 0l-2.97 2.97ZM12 7a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z" clip-rule="evenodd" />
              </svg>
            </div>
          </div>
          <h1 class="text-4xl md:text-5xl font-bold mb-3 font-poppins bg-clip-text text-transparent bg-gradient-to-r from-teal-200 via-blue-300 to-purple-300 tracking-wide">
            MediClick
          </h1>
          <p class="text-lg opacity-90 font-light mb-6">Advanced AI-Powered Medical Image Analysis</p>

          <!-- Hero Statement + CTA -->
          <p class="text-base md:text-lg text-white/90 mb-6">Start your journey towards faster, AI-powered diagnosis today.</p>
          <a href="#analysisForm" class="inline-block px-6 py-3 rounded-full bg-gradient-to-r from-teal-400 via-blue-500 to-indigo-600 text-white font-poppins font-semibold shadow-lg hover:shadow-2xl transform hover:scale-105 transition ripple">Get Started</a>
        </div>

        <!-- Illustration -->
        <div class="hidden md:flex justify-center">
          <img src="https://cdn-icons-png.flaticon.com/512/2966/2966486.png" alt="Medical Illustration" class="w-64 h-64 object-contain drop-shadow-lg">
        </div>
      </div>
    </header>

    <!-- Main content -->
    <main class="grid md:grid-cols-2">
      
      <!-- Upload Section -->
      <section class="p-8 bg-gradient-to-br from-white/70 to-gray-50/70 backdrop-blur-sm flex flex-col justify-center">
        <form id="analysisForm" enctype="multipart/form-data" class="space-y-6">
          
          <!-- Upload Box -->
          <div id="uploadArea" class="border-2 border-dashed border-indigo-400 rounded-xl p-8 text-center bg-white/70 hover:bg-indigo-50/70 transition cursor-pointer relative">
            <div id="uploadIcon" class="flex justify-center mb-4">
              <div class="w-14 h-14 bg-gradient-to-r from-blue-400 to-indigo-500 rounded-full flex items-center justify-center shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" class="w-7 h-7">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 10.5L12 6l-4.5 4.5M12 6v12" />
                </svg>
              </div>
            </div>
            <h3 id="uploadHeading" class="text-xl font-poppins font-semibold mb-2 text-gray-700">Upload Medical Image</h3>
            <p class="text-gray-500 text-sm">Drag & drop or click to browse</p>
            <p class="text-gray-400 text-xs mt-2">Supported: JPG, PNG, GIF • Max: 10MB</p>
            <p id="fileDetails" class="text-gray-600 text-sm mt-2"></p>
            <button type="button" id="chooseBtn" class="mt-4 px-6 py-3 rounded-full bg-gradient-to-r from-indigo-500 via-blue-500 to-teal-500 text-white font-poppins font-semibold shadow-lg hover:shadow-2xl transform hover:scale-105 transition ripple">Choose Image</button>
            <input type="file" id="imageFile" name="image" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*">
          </div>

          <!-- Preview -->
          <img id="previewImage" class="hidden max-h-64 mx-auto rounded-lg shadow-lg border border-gray-200" alt="Preview">

          <!-- Query Input -->
          <textarea id="queryText" name="query" class="w-full p-4 border rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none resize-none h-32 font-roboto text-gray-700" placeholder="Describe your symptoms or ask about the medical condition..." required></textarea>

          <!-- Analyze Button -->
          <button id="analyzeBtn" type="submit" class="w-full py-3 rounded-full bg-gradient-to-r from-teal-600 via-blue-600 to-indigo-600 text-white text-lg font-poppins font-bold shadow-lg hover:shadow-2xl transform hover:scale-105 transition ripple tracking-wide">Analyze Medical Image</button>
        </form>
      </section>

      <!-- Results Section -->
      <section id="resultsSection" class="p-8 bg-white/80 backdrop-blur-md overflow-y-auto max-h-[800px]">
        
        <!-- Loading -->
        <div id="loadingDiv" class="hidden text-center py-16">
          <div class="w-14 h-14 border-4 border-gray-200 border-t-indigo-500 rounded-full animate-spin mx-auto mb-6"></div>
          <h3 class="text-xl font-poppins text-indigo-600 mb-2 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 animate-pulse">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 2.25c5.385 0 9.75 4.365 9.75 9.75S17.385 21.75 12 21.75 2.25 17.385 2.25 12 6.615 2.25 12 2.25z" />
            </svg>
            AI Analysis in Progress...
          </h3>
          <p class="text-gray-600">Medi AI is carefully analyzing your medical image.</p>
        </div>

        <!-- Results -->
        <div id="resultsDiv" class="hidden space-y-6">
          <!-- Success card example -->
          <div class="success-card hidden bg-green-50 border border-green-200 rounded-xl p-6 shadow-md fade-in slide-up">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center animate-bounce">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="white" class="w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                </svg>
              </div>
              <h3 class="text-lg font-poppins font-semibold text-green-700">Analysis Successful</h3>
            </div>
            <div class="text-gray-700 text-sm leading-relaxed">Your medical image has been analyzed successfully. Results will display here.</div>
          </div>

          <!-- Error card example -->
          <div class="error-card hidden bg-red-50 border border-red-200 rounded-xl p-6 shadow-md fade-in slide-up">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center animate-bounce">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="white" class="w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2.25m0 3h.008v.008H12V14.25zM21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" />
                </svg>
              </div>
              <h3 class="text-lg font-poppins font-semibold text-red-700">Analysis Failed</h3>
            </div>
            <div class="text-gray-700 text-sm leading-relaxed">Something went wrong during the analysis. Please try again.</div>
          </div>
        </div>

        <!-- Welcome Message -->
        <div id="welcomeMessage" class="text-center py-16 text-gray-600 fade-in">
          <div class="flex justify-center mb-4">
            <div class="w-14 h-14 bg-gradient-to-r from-indigo-400 to-blue-600 rounded-full flex items-center justify-center shadow-md animate-pulse">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" class="w-7 h-7">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5M12 2.25c5.385 0 9.75 4.365 9.75 9.75S17.385 21.75 12 21.75 2.25 17.385 2.25 12 6.615 2.25 12 2.25z" />
              </svg>
            </div>
          </div>
          <h2 class="text-2xl font-poppins bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 via-blue-500 to-teal-500 mb-4 tracking-wide">Welcome to MediClick</h2>
          <p class="max-w-lg mx-auto text-base leading-relaxed">Upload a medical image and describe your symptoms to get an AI-powered analysis. Our system provides detailed observations, potential diagnoses, severity evaluation, and professional recommendations.</p>
          <div class="flex justify-center mt-6">
            <span class="px-4 py-1 rounded-full bg-indigo-50 text-indigo-600 text-sm font-poppins font-semibold">Accurate Analysis</span>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- Your JS -->
  <script src="script.js"></script>
</body>

    <script>
        let selectedFile = null;
        let isAnalyzing = false;

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('imageFile');
        const chooseBtn = document.getElementById('chooseBtn');
        const uploadIcon = document.getElementById('uploadIcon');
        const uploadHeading = document.getElementById('uploadHeading');
        const fileDetails = document.getElementById('fileDetails');
        const previewImage = document.getElementById('previewImage');
        const analysisForm = document.getElementById('analysisForm');
        const loadingDiv = document.getElementById('loadingDiv');
        const resultsDiv = document.getElementById('resultsDiv');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const queryText = document.getElementById('queryText');

        // Make entire area clickable while keeping input in DOM
        chooseBtn.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('click', (e) => {
            const isInteractive = e.target === fileInput || e.target === chooseBtn;
            if (!isInteractive) fileInput.click();
        });

        // File upload event listeners
        fileInput.addEventListener('change', handleFileSelect);

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                fileInput.files = files; // will trigger change event in some browsers; ensure call
                handleFileSelect({ target: { files } });
            }
        });

        // Form submission
        analysisForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isAnalyzing) return;
            if (!selectedFile) { showError('Please select a medical image to analyze'); return; }
            const query = queryText.value.trim();
            if (!query) { showError('Please describe your symptoms or ask a specific question about the image'); return; }
            await performAnalysis();
        });

        function handleFileSelect(e) {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) { showError('Please select a valid image file (JPG, PNG, or GIF)'); return; }
            if (file.size > 10 * 1024 * 1024) { showError('Image file must be smaller than 10MB'); return; }

            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (ev) => {
                previewImage.src = ev.target.result;
                previewImage.style.display = 'block';

                uploadIcon.textContent = '✅';
                uploadHeading.textContent = 'Image Ready for Analysis!';
                fileDetails.textContent = `${file.name} • ${(file.size / 1024 / 1024).toFixed(2)}MB`;
            };
            reader.readAsDataURL(file);

            clearResults();
        }

        async function performAnalysis() {
            if (isAnalyzing) return;
            isAnalyzing = true;
            // Show loading state
            welcomeMessage.style.display = 'none';
            resultsDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Analyzing...';

            try {
                const formData = new FormData();
                formData.append('image', selectedFile);
                formData.append('query', queryText.value.trim());

                const response = await fetch('/upload_and_query', { method: 'POST', body: formData });
                if (!response.ok) throw new Error(`Server error: ${response.status} ${response.statusText}`);
                const result = await response.json();
                displayResults(result);
            } catch (error) {
                console.error('Analysis error:', error);
                showError(`Failed to analyze image: ${error.message}. Please check your connection and try again.`);
            } finally {
                isAnalyzing = false;
                loadingDiv.style.display = 'none';
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze Medical Image';
            }
        }

        function displayResults(data) {
            if (!data) { showError('No response received from the server'); return; }
            resultsDiv.innerHTML = '';

            if (data.success) {
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                const provider = data.model_info && (data.model_info.provider || 'Medi AI');
                const name = data.model_info && (data.model_info.name || 'Model');
                const cost = data.model_info && (data.model_info.cost || '');
                const subtitle = cost ? `${provider} • ${cost}` : provider;

                resultCard.innerHTML = `
                    <div class="result-header">
                        <div class="result-icon success-icon">🎯</div>
                        <div>
                            <div class="result-title">${escapeHtml(name)}</div>
                            <div class="result-subtitle">${escapeHtml(subtitle)}</div>
                        </div>
                    </div>
                    <div class="result-content formatted-text">${formatAnalysisText(data.analysis && data.analysis.content)}</div>
                `;
                resultsDiv.appendChild(resultCard);

            } else {
                const errorCard = document.createElement('div');
                errorCard.className = 'error-card';
                const provider = data.model_info ? (data.model_info.provider || 'Medi Ai') : 'Medi Ai';
                let suggestionsHTML = '';
                if (data.error && Array.isArray(data.error.suggestions) && data.error.suggestions.length > 0) {
                    suggestionsHTML = `
                        <div class="error-suggestions">
                            <h4>💡 Troubleshooting Suggestions:</h4>
                            <ul>${data.error.suggestions.map(s => `<li>${escapeHtml(s)}</li>`).join('')}</ul>
                        </div>`;
                }
                const errorMsg = data.error && data.error.message ? data.error.message : 'Unknown error occurred.';
                errorCard.innerHTML = `
                    <div class="result-header">
                        <div class="result-icon error-icon">❌</div>
                        <div>
                            <div class="result-title">Analysis Failed</div>
                            <div class="result-subtitle">${escapeHtml(provider)}</div>
                        </div>
                    </div>
                    <div class="result-content">
                        <p><strong>Error:</strong> ${escapeHtml(errorMsg)}</p>
                        ${suggestionsHTML}
                    </div>
                `;
                resultsDiv.appendChild(errorCard);
            }

            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function formatAnalysisText(text) {
            if (!text) return '<p>No analysis content available.</p>';
            let formatted = String(text).trim();

            formatted = formatted.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');

            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            formatted = formatted.replace(/(EMERGENCY:.*?)(?=\n|$)/gi, '<div class="severity-emergency">🚨 $1</div>');
            formatted = formatted.replace(/(URGENT:.*?)(?=\n|$)/gi, '<div class="severity-urgent">⚠️ $1</div>');
            formatted = formatted.replace(/(ROUTINE:.*?)(?=\n|$)/gi, '<div class="severity-routine">✅ $1</div>');


            formatted = formatted.replace(/^\-\s+(.*)$/gm, '<li>$1</li>');

            formatted = formatted.replace(/(?:<li>[\s\S]*?<\/li>\s*)+/g, (m) => `<ul>${m}</ul>`);


            const parts = formatted.split(/\n\n+/);
            let result = '';
            for (let paragraph of parts) {
                paragraph = paragraph.trim();
                if (!paragraph) continue;
                if (
                    paragraph.startsWith('<h2') ||
                    paragraph.startsWith('<h3') ||
                    paragraph.startsWith('<div class="severity') ||
                    paragraph.startsWith('<ul>') ||
                    paragraph.startsWith('<ol>') ||
                    paragraph.startsWith('<p>')
                ) {
                    result += paragraph + '\n';
                } else {
                    result += '<p>' + paragraph.replace(/\n/g, ' ') + '</p>\n';
                }
            }
            return result || '<p>Analysis completed successfully.</p>';
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function showError(message) {
            resultsDiv.innerHTML = `
                <div class="error-card">
                    <div style="text-align: center;">
                        <div style="font-size: 3em; margin-bottom: 20px;">❌</div>
                        <h3 style="color: #721c24; margin-bottom: 15px;">Analysis Error</h3>
                        <p><strong>${escapeHtml(message)}</strong></p>
                    </div>
                </div>`;
            welcomeMessage.style.display = 'none';
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            resultsDiv.style.display = 'none';
            if (!selectedFile) welcomeMessage.style.display = 'block';
        }

        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/health');
                const health = await response.json();
                const statusBadge = document.getElementById('statusBadge');
                if (health.status === 'healthy') {
                    statusBadge.innerHTML = '✅ Service Online • Google AI Studio Connected • Ready for Analysis';
                    statusBadge.style.background = 'rgba(40, 167, 69, 0.2)';
                } else {
                    statusBadge.innerHTML = '⚠️ Setup Required • Check API Configuration';
                    statusBadge.style.background = 'rgba(255, 193, 7, 0.2)';
                    showError('Service setup required. Please check your Google AI Studio API key configuration.');
                }
            } catch (error) {
                console.warn('Health check failed:', error);
                document.getElementById('statusBadge').innerHTML = '⚠️ Connection Issue • Please Refresh';
            }
        });

        const sampleQueries = [
            'What medical condition does this image show?',
            'Please analyze this skin condition and provide recommendations.',
            'What abnormalities can you identify in this medical image?',
            'Is this condition serious? What should I do?',
            'Analyze this X-ray for any concerning features.'
        ];
        queryText.addEventListener('focus', () => {
            if (!queryText.value) {
                const randomQuery = sampleQueries[Math.floor(Math.random() * sampleQueries.length)];
                queryText.placeholder = `Try: "${randomQuery}" or describe your symptoms...`;
            }
        });
    </script>
</body>
</html>
